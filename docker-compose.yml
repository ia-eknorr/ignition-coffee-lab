---
x-ignition-common: &ignition-common
  image: &ignition-image inductiveautomation/ignition:8.3.2
  depends_on:
    db:
      condition: service_healthy
    bootstrap:
      condition: service_completed_successfully
  networks:
    proxy: {}

x-ignition-environment: &ignition-environment
  ACCEPT_IGNITION_EULA: "Y"
  IGNITION_EDITION: standard
  TZ: ${TZ}

x-emqx-environment: &emqx-environment
  EMQX_NAME: emqx
  EMQX_HOST: 127.0.0.1
  # Dashboard admin credentials
  EMQX_DASHBOARD__DEFAULT_USERNAME: ${EMQX_DASHBOARD_USER:-admin}
  EMQX_DASHBOARD__DEFAULT_PASSWORD: ${EMQX_DASHBOARD_PASSWORD:-public}
  # Allow anonymous connections for dev
  EMQX_ALLOW_ANONYMOUS: "true"
  EMQX_LISTENERS__TCP__DEFAULT__ENABLE: "true"
  EMQX_LISTENERS__WS__DEFAULT__ENABLE: "true"
  # File-based ACL authorization
  EMQX_AUTHORIZATION__NO_MATCH: allow
  EMQX_AUTHORIZATION__SOURCES: "[{type=file,enable=true,path=\"/opt/emqx/etc/acl.conf\"}]"

services:
  bootstrap:
    image: *ignition-image
    user: root
    entrypoint: ["/bin/bash", "/docker-bootstrap.sh"]
    environment:
      GATEWAY_NAME: ${GATEWAY_NAME}
    volumes:
      - ignition-data:/data
      - ./scripts/docker-bootstrap.sh:/docker-bootstrap.sh

  gateway:
    <<: [*ignition-common]
    container_name: ${GATEWAY_NAME}
    hostname: ${GATEWAY_NAME}
    volumes:
      - ignition-data:/usr/local/bin/ignition/data
      - ./services/ignition/projects:/usr/local/bin/ignition/data/projects
      - ./services/ignition/config/resources/core:/usr/local/bin/ignition/data/config/resources/core
      - ./services/ignition/config/resources/dev:/usr/local/bin/ignition/data/config/resources/dev
    environment:
      <<: *ignition-environment
    labels:
      - traefik.hostname=${GATEWAY_NAME}
      - traefik.enable=true
    command: >
      -n ${GATEWAY_NAME}
      -m 4096
      -h 80
      -s 443
      -a ${GATEWAY_NAME}.localtest.me
      --
      gateway.useProxyForwardedHeader=true
      -Dignition.config.mode=${DEPLOYMENT_MODE:-dev}

  db:
    image: postgres:18.1
    hostname: db-${GATEWAY_NAME}
    container_name: db-${GATEWAY_NAME}
    volumes:
      - ./services/db/init:/docker-entrypoint-initdb.d
    environment:
      TZ: ${TZ}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-U", "ignition"]
      interval: 10s
      timeout: 20s
      retries: 10
    networks:
      proxy:
        aliases:
          - db-${GATEWAY_NAME}

  mqtt:
    image: emqx/emqx:5.8
    container_name: mqtt-${GATEWAY_NAME}
    hostname: mqtt
    environment:
      <<: *emqx-environment
      TZ: ${TZ}
    ports:
      # MQTT TCP - exposed on host for Pico W access
      - "1883:1883"
      # MQTT WebSocket - for browser clients
      - "8083:8083"
      # Dashboard - accessible via Traefik or direct
      - "18083:18083"
    volumes:
      - emqx-data:/opt/emqx/data
      - emqx-log:/opt/emqx/log
      - ./services/mqtt/acl.conf:/opt/emqx/etc/acl.conf:ro
    healthcheck:
      test: ["CMD", "emqx", "ctl", "status"]
      interval: 10s
      timeout: 10s
      retries: 5
    labels:
      - traefik.enable=true
      - traefik.http.routers.mqtt-dashboard.rule=Host(`mqtt.localtest.me`)
      - traefik.http.routers.mqtt-dashboard.entrypoints=web
      - traefik.http.services.mqtt-dashboard.loadbalancer.server.port=18083
    networks:
      proxy:
        aliases:
          - mqtt

volumes:
  ignition-data:
  emqx-data:
  emqx-log:

networks:
  proxy:
    external: true
